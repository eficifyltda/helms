{{- if .Values.readReplica.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgresql.fullname" . }}-read-replica-config
  labels:
    {{- include "postgresql.readReplica.labels" . | nindent 4 }}
data:
  postgresql.conf: |
    # PostgreSQL Read Replica Configuration
    # Hot Standby settings
    hot_standby = on
    hot_standby_feedback = on
    max_standby_streaming_delay = 30s
    max_standby_archive_delay = 300s
    
    # Connection settings
    max_connections = {{ .Values.postgresql.config.max_connections }}
    
    # Memory settings (pode ser menor que o master)
    shared_buffers = {{ .Values.postgresql.config.shared_buffers }}
    effective_cache_size = {{ .Values.postgresql.config.effective_cache_size }}
    maintenance_work_mem = {{ .Values.postgresql.config.maintenance_work_mem }}
    work_mem = {{ .Values.postgresql.config.work_mem }}
    
    # WAL settings
    wal_buffers = {{ .Values.postgresql.config.wal_buffers }}
    min_wal_size = {{ .Values.postgresql.config.min_wal_size }}
    max_wal_size = {{ .Values.postgresql.config.max_wal_size }}
    
    # Query planner
    random_page_cost = {{ .Values.postgresql.config.random_page_cost }}
    effective_io_concurrency = {{ .Values.postgresql.config.effective_io_concurrency }}
    default_statistics_target = {{ .Values.postgresql.config.default_statistics_target }}
    
    # Parallel query
    max_worker_processes = {{ .Values.postgresql.config.max_worker_processes }}
    max_parallel_workers_per_gather = {{ .Values.postgresql.config.max_parallel_workers_per_gather }}
    max_parallel_workers = {{ .Values.postgresql.config.max_parallel_workers }}
    max_parallel_maintenance_workers = {{ .Values.postgresql.config.max_parallel_maintenance_workers }}
    
    # Logging
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 1000
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on
    log_temp_files = 0
{{- end }}

