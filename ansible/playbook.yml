---
- name: Setup Ubuntu server with k3s, kubectl and helm
  hosts: all
  become: true
  vars:
    k3s_version: "latest"
    kubectl_version: "latest"
    helm_version: "latest"
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Install kubectl
      block:
        - name: Get latest kubectl version
          uri:
            url: https://dl.k8s.io/release/stable.txt
            return_content: true
          register: kubectl_stable_version
          when: kubectl_version == "latest"
        
        - name: Download kubectl binary (specific version)
          get_url:
            url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
            dest: /tmp/kubectl
            mode: '0755'
          when: kubectl_version != "latest"
        
        - name: Download latest kubectl binary
          get_url:
            url: "https://dl.k8s.io/release/{{ kubectl_stable_version.content | trim }}/bin/linux/amd64/kubectl"
            dest: /tmp/kubectl
            mode: '0755'
          when: kubectl_version == "latest"
        
        - name: Install kubectl to /usr/local/bin
          copy:
            src: /tmp/kubectl
            dest: /usr/local/bin/kubectl
            mode: '0755'
            remote_src: yes
        
        - name: Verify kubectl installation
          command: kubectl version --client
          register: kubectl_version_output
          changed_when: false
        
        - name: Display kubectl version
          debug:
            msg: "{{ kubectl_version_output.stdout }}"

    - name: Install k3s
      block:
        - name: Install k3s server
          shell: |
            curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION={{ k3s_version }} sh -
          args:
            creates: /usr/local/bin/k3s
          when: k3s_version != "latest"
        
        - name: Install latest k3s server
          shell: |
            curl -sfL https://get.k3s.io | sh -
          args:
            creates: /usr/local/bin/k3s
          when: k3s_version == "latest"
        
        - name: Wait for k3s to be ready
          wait_for:
            path: /etc/rancher/k3s/k3s.yaml
            timeout: 300
        
        - name: Get ansible user info
          become: false
          shell: |
            echo "HOME=$(echo $HOME)"
            echo "USER=$(whoami)"
          register: user_info
          changed_when: false
        
        - name: Extract user home and username
          set_fact:
            user_home: "{{ user_info.stdout_lines[0] | regex_replace('HOME=', '') }}"
            current_user: "{{ user_info.stdout_lines[1] | regex_replace('USER=', '') }}"
        
        - name: Create .kube directory for user
          file:
            path: "{{ user_home }}/.kube"
            state: directory
            mode: '0755'
            owner: "{{ current_user }}"
            group: "{{ current_user }}"
        
        - name: Read k3s kubeconfig
          slurp:
            src: /etc/rancher/k3s/k3s.yaml
          register: k3s_kubeconfig
        
        - name: Decode and prepare kubeconfig content
          set_fact:
            kubeconfig_content: "{{ k3s_kubeconfig.content | b64decode }}"
        
        - name: Write kubeconfig to user home
          copy:
            content: "{{ kubeconfig_content }}"
            dest: "{{ user_home }}/.kube/config"
            mode: '0600'
            owner: "{{ current_user }}"
            group: "{{ current_user }}"
        
        - name: Ensure bashrc exists
          file:
            path: "{{ user_home }}/.bashrc"
            state: touch
            owner: "{{ current_user }}"
            group: "{{ current_user }}"
            mode: '0644'
        
        - name: Ensure zshrc exists
          file:
            path: "{{ user_home }}/.zshrc"
            state: touch
            owner: "{{ current_user }}"
            group: "{{ current_user }}"
            mode: '0644'
        
        - name: Set KUBECONFIG environment variable in shell profiles
          blockinfile:
            path: "{{ item }}"
            marker: "# {mark} ANSIBLE MANAGED BLOCK - KUBECONFIG"
            block: |
              export KUBECONFIG={{ user_home }}/.kube/config
            create: true
            owner: "{{ current_user }}"
            group: "{{ current_user }}"
          loop:
            - "{{ user_home }}/.bashrc"
            - "{{ user_home }}/.zshrc"
        
        - name: Verify k3s installation
          command: k3s --version
          register: k3s_version_output
          changed_when: false
        
        - name: Display k3s version
          debug:
            msg: "{{ k3s_version_output.stdout }}"
        
        - name: Verify kubectl can connect to k3s (as root)
          command: kubectl get nodes
          register: kubectl_nodes
          changed_when: false
        
        - name: Display k3s nodes
          debug:
            msg: "{{ kubectl_nodes.stdout_lines }}"
        
        - name: Verify kubectl can connect to k3s (as user)
          become: false
          environment:
            KUBECONFIG: "{{ user_home }}/.kube/config"
          command: kubectl get nodes
          register: kubectl_nodes_user
          changed_when: false
        
        - name: Display k3s nodes (user verification)
          debug:
            msg: "{{ kubectl_nodes_user.stdout_lines }}"

    - name: Install Helm
      block:
        - name: Download Helm install script
          get_url:
            url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            dest: /tmp/get-helm-3.sh
            mode: '0755'
        
        - name: Install Helm
          shell: /tmp/get-helm-3.sh
          args:
            creates: /usr/local/bin/helm
        
        - name: Verify Helm installation
          command: helm version
          register: helm_version_output
          changed_when: false
        
        - name: Display Helm version
          debug:
            msg: "{{ helm_version_output.stdout }}"

    - name: Setup aliases for kubectl and helm
      block:
        - name: Get ansible user info for aliases
          become: false
          shell: |
            echo "HOME=$(echo $HOME)"
            echo "USER=$(whoami)"
          register: user_info_aliases
          changed_when: false
        
        - name: Extract user home and username for aliases
          set_fact:
            user_home_aliases: "{{ user_info_aliases.stdout_lines[0] | regex_replace('HOME=', '') }}"
            current_user_aliases: "{{ user_info_aliases.stdout_lines[1] | regex_replace('USER=', '') }}"
        
        - name: Add kubectl and helm aliases to bashrc
          blockinfile:
            path: "{{ user_home_aliases }}/.bashrc"
            marker: "# {mark} ANSIBLE MANAGED BLOCK - KUBECTL/HELM ALIASES"
            block: |
              alias k='kubectl'
              alias h='helm'
            create: true
            owner: "{{ current_user_aliases }}"
            group: "{{ current_user_aliases }}"
        
        - name: Add kubectl and helm aliases to zshrc
          blockinfile:
            path: "{{ user_home_aliases }}/.zshrc"
            marker: "# {mark} ANSIBLE MANAGED BLOCK - KUBECTL/HELM ALIASES"
            block: |
              alias k='kubectl'
              alias h='helm'
            create: true
            owner: "{{ current_user_aliases }}"
            group: "{{ current_user_aliases }}"

    - name: Summary
      debug:
        msg:
          - "✓ System updated and upgraded"
          - "✓ kubectl installed"
          - "✓ k3s installed and running"
          - "✓ Helm installed"
          - ""
          - "You can now use kubectl and helm to manage your k3s cluster"

